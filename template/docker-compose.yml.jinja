---
name: "{{ project_dir }}-www"

networks:
  default:
    name: {{ project_dir }}-www-network
    driver: bridge

# Named volumes for persistent data
volumes:
  webmail-data:
    driver: local

# Common service configuration
x-services-base: &services-base
  extra_hosts:
    - host.docker.internal:host-gateway
  build:
    context: .
    dockerfile: ./docker/django/Dockerfile
    args:
      - BUILDKIT_INLINE_CACHE=1
  volumes:
    - .:/app:z
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# Common environment variables
x-services-env: &services-env
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"

services:
  django:
    <<: *services-base
    environment:
      <<: *services-env
      ROOT_URLCONF: project.urls
    healthcheck:
      test: ["CMD", "python", "manage.py", "check", "--deploy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - default

  nginx:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
      cache_from:
        - public.ecr.aws/nginx/nginx:1.28-bookworm
      args:
        - BUILDKIT_INLINE_CACHE=1
    depends_on:
      django:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default

  webmail:
    profiles:
      - local
      - staging
      - webmail
    build:
      context: .
      dockerfile: ./docker/webmail/Dockerfile
    restart: unless-stopped
    volumes:
      - webmail-data:/data
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8025/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default
